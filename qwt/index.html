<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>Quake Web Tools</title>
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon.png">
    <link rel="stylesheet" href="QuakeWebTools/css/style.css">

    <!--lib-->
    <script src="QuakeWebTools/scripts/lib/stats.min.js"></script>
    <script src="QuakeWebTools/scripts/lib/DataStream.js"></script>
    <script src="QuakeWebTools/scripts/lib/three.js"></script>
    <script src="QuakeWebTools/scripts/lib/orbitcontrols.js"></script>
    <script src="QuakeWebTools/scripts/lib/firstpersoncontrols.js"></script>
    <!--util-->
    <script src="QuakeWebTools/scripts/util/filemanager.js"></script>
    <script src="QuakeWebTools/scripts/util/fileutil.js"></script>
    <script src="QuakeWebTools/scripts/util/imageutil.js"></script>
    <!--types-->
    <script src="QuakeWebTools/scripts/types/pak.js"></script>
    <script src="QuakeWebTools/scripts/types/wad.js"></script>
    <script src="QuakeWebTools/scripts/types/pal.js"></script>
    <script src="QuakeWebTools/scripts/types/lmp.js"></script>
    <script src="QuakeWebTools/scripts/types/spr.js"></script>
    <script src="QuakeWebTools/scripts/types/bsp.js"></script>
    <script src="QuakeWebTools/scripts/types/mdl.js"></script>
    <!--application-->
    <script src="QuakeWebTools/scripts/quakewebtools.js"></script>
  </head>

  <body onload="app_init()" style="width: 540px">

    <article>
      <div id="holder" class="filedrop" style="min-height: 100px; cursor:pointer"
           role="button" tabindex="0" aria-label="Drop files here or click to select">
        <h1 style="font-size: 2em">DROP FILES HERE</h1>
        <p>Drag Quake file format files (pak, wad, bsp, lmp, spr, mdl, map,
        pal) into this area to load their content in your browser.</p>
        <div id="file-content" class="" style="border:0">
        </div>
        <div id="loading-indicator" class="loading hidden" aria-live="polite">
          <p id="loading-message">Loading…</p>
          <div class="progress-bar" role="progressbar"
               aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div id="loading-progress" class="progress-bar-fill"></div>
          </div>
        </div>
      </div> 
      <p id="status">File API and FileReader API not supported</p>

      <!-- Hidden file input to support click-to-select -->
      <input id="file_input" type="file" style="display:none"
             multiple
             accept=".pak,.wad,.bsp,.lmp,.spr,.mdl,.map,.pal" />
    </article>



  </body>
</html>



<!-- TODO: Clean up this mess and put it in a better location -->
<script>


// stats
if (0) {
  var stats = new Stats();
  stats.setMode(1); // 0: fps, 1: ms
  // Align top-left
  stats.domElement.style.position = 'absolute';
  stats.domElement.style.left = '0px';
  stats.domElement.style.top = '0px';
  document.body.appendChild( stats.domElement );
  QuakeWebTools.STATS = stats;
}

var holder = document.getElementById('holder');
var state = document.getElementById('status');
var fileInput = document.getElementById('file_input');
var loadingIndicator = document.getElementById('loading-indicator');
var loadingMessage = document.getElementById('loading-message');
var loadingProgress = document.getElementById('loading-progress');
var loadingProgressBar = loadingIndicator ? loadingIndicator.querySelector('.progress-bar') : null;

if (typeof window.FileReader === 'undefined') {
  state.className = 'fail';
} else {
  state.parentNode.removeChild(state);
}

function clampProgress(value) {
  return Math.max(0, Math.min(100, Math.round(value)));
}

function showLoadingIndicator(message) {
  if (!loadingIndicator || !loadingProgressBar || !loadingMessage || !loadingProgress) return;
  loadingIndicator.classList.remove('hidden');
  loadingProgressBar.classList.remove('indeterminate');
  loadingProgress.style.width = '0%';
  loadingProgressBar.setAttribute('aria-valuenow', '0');
  loadingProgressBar.removeAttribute('aria-valuetext');
  loadingMessage.textContent = message;
}

function updateDeterminateProgress(percent, message) {
  if (!loadingIndicator || !loadingProgressBar || !loadingMessage || !loadingProgress) return;
  var clamped = clampProgress(percent);
  loadingProgressBar.classList.remove('indeterminate');
  loadingProgress.style.width = clamped + '%';
  loadingProgressBar.setAttribute('aria-valuenow', String(clamped));
  loadingProgressBar.removeAttribute('aria-valuetext');
  if (message) loadingMessage.textContent = message;
}

function updateIndeterminateProgress(message) {
  if (!loadingIndicator || !loadingProgressBar || !loadingMessage || !loadingProgress) return;
  loadingProgressBar.classList.add('indeterminate');
  loadingProgress.style.width = '40%';
  loadingProgressBar.removeAttribute('aria-valuenow');
  loadingProgressBar.setAttribute('aria-valuetext', 'Loading');
  if (message) loadingMessage.textContent = message;
}

function hideLoadingIndicator() {
  if (!loadingIndicator || !loadingProgressBar || !loadingMessage || !loadingProgress) return;
  loadingIndicator.classList.add('hidden');
  loadingProgressBar.classList.remove('indeterminate');
  loadingProgress.style.width = '0%';
  loadingProgressBar.setAttribute('aria-valuenow', '0');
  loadingProgressBar.removeAttribute('aria-valuetext');
  loadingMessage.textContent = 'Loading…';
}

// Shared file handler used by both drag-drop and picker
function handleFile(file) {
  if (!file) return;
  var reader = new FileReader();

  reader.onloadstart = function () {
    showLoadingIndicator("Loading " + file.name + "…");
  };

  reader.onprogress = function (event) {
    if (!event.lengthComputable) {
      updateIndeterminateProgress("Loading " + file.name + "…");
      return;
    }
    var percentLoaded = event.total > 0 ? (event.loaded / event.total) * 100 : 100;
    updateDeterminateProgress(percentLoaded, "Loading " + file.name + "… (" + clampProgress(percentLoaded) + "%)");
  };

  reader.onerror = function (event) {
    console.error("Error reading file:", file.name, event);
    hideLoadingIndicator();
    alert("Unable to read " + file.name + ". Please try again.");
  };

  reader.onload = function (event) {
    updateIndeterminateProgress("Processing " + file.name + "…");
    var QWT = QuakeWebTools;
    var G = QWT.GLOBAL;

    try {
      var file_entry = G.FILEMANAGER.addFile(file.name, event.target.result);
      var filename = file_entry.path;
      var arraybuffer = file_entry.data;

      // stop any running viewer animation
      if (QWT.ANIMATION_ID != null) {
        console.log("stopping animationFrame " + QWT.ANIMATION_ID);
        cancelAnimationFrame(QWT.ANIMATION_ID);
        QWT.ANIMATION_ID = null;
      }

      document.getElementById("file-content").innerHTML = "";

      switch (file_entry.type) {
        case "pak":
          viewPAK(file_entry.obj);
          break;
        case "wad":
          QWT.ImageUtil.generateHTMLPreview({image_infos: file_entry.obj.directory, arraybuffer: file_entry.obj.ab},
            QWT.DEFAULT_PALETTE, "file-content");
          break;
        case "bsp":
          QWT.ANIMATION_ID = viewBSP(file_entry.obj);
          QWT.ImageUtil.generateHTMLPreview({image_infos: file_entry.obj.miptex_directory, arraybuffer: file_entry.obj.ab},
            QWT.DEFAULT_PALETTE, "file-content");
          break;
        case "spr":
          QWT.ImageUtil.generateHTMLPreview({image_datas: file_entry.obj.getImageData()},
            QWT.DEFAULT_PALETTE, "file-content");
          break;
        case "lmp":
        case "pal":
          QWT.ImageUtil.generateHTMLPreview({image_datas: [QWT.ImageUtil.getImageData(filename, arraybuffer)]},
            QWT.DEFAULT_PALETTE, "file-content");
          break;
        case "mdl":
          QWT.ANIMATION_ID = viewMDL(file_entry.obj);
          QWT.ImageUtil.generateHTMLPreview({image_datas: file_entry.obj.skins}, QWT.DEFAULT_PALETTE, "file-content");
          break;
        default:
          alert("File type not supported (" + file_entry.type + ")");
      }
    } catch (err) {
      console.error("Failed to process file:", file.name, err);
      alert("Failed to process " + file.name + ". Check the developer console for details.");
    } finally {
      hideLoadingIndicator();
    }
  };

  reader.readAsArrayBuffer(file);
}

holder.ondragover = function () { this.className = 'filedrop-hover'; return false; };
holder.ondragleave = function () { this.className = 'filedrop'; return false; };
holder.ondragend = holder.ondragleave;
holder.ondrop = function (e) {
  this.className = 'filedrop';
  e.preventDefault();
  // Support multiple file drops
  for (const file of e.dataTransfer.files) handleFile(file);
  return false;
};

// Click-to-select behavior
holder.addEventListener('click', function () {
  fileInput && fileInput.click();
});
holder.addEventListener('keydown', function (e) {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    fileInput && fileInput.click();
  }
});

// Picker ? process selected files
fileInput.addEventListener('change', function (e) {
  const files = Array.from(e.target.files || []);
  files.forEach(handleFile);
  // reset so selecting the same file again still triggers change
  e.target.value = '';
});

</script>
